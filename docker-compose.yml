services:
  audiobook:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: audiobook
    ports:
      - "4001:80"
    env_file:
      - .env.development
    environment:
      # Azure Functions 런타임 설정
      - AzureWebJobsScriptRoot=/home/site/wwwroot
      - AzureFunctionsJobHost__Logging__Console__IsEnabled=true
      - AzureWebJobsFeatureFlags=EnableWorkerIndexing
      - FUNCTIONS_WORKER_RUNTIME=python
      - AzureFunctionsJobHost__Logging__LogLevel__Default=Debug
      - AzureFunctionsJobHost__Logging__LogLevel__Function=Debug
      # UTF-8 인코딩
      - PYTHONIOENCODING=utf-8
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
      # Vertex AI 파일 경로 (컨테이너 내부 경로로 오버라이드)
      - VERTEX_AI_SERVICE_ACCOUNT_FILE=/home/site/wwwroot/vertex-ai-service-account.json
      - AzureWebJobs_NoDotNetWatch=true
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      # 코드 변경 반영 (읽기+쓰기)
      - ./app:/home/site/wwwroot/app
      - ./middleware:/home/site/wwwroot/middleware
      - ./function_app.py:/home/site/wwwroot/function_app.py
      - ./config.py:/home/site/wwwroot/config.py
      - ./host.json:/home/site/wwwroot/host.json
      - ./vertex-ai-service-account.json:/home/site/wwwroot/vertex-ai-service-account.json:ro
      # 출력 파일 영구 저장
      - ./outputs:/home/site/wwwroot/outputs
    restart: unless-stopped
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:80/api/v1/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s
    networks:
      - audiobook-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  audiobook-network:
    driver: bridge